name: Generate Type Stubs

on:
  push:
    branches: [main, master]
    paths:
     - '.github/workflows/stubgen.yaml'
     - 'faster_eth_abi/**.py'
     - 'pyproject.toml'
     - 'setup.py'
  pull_request:
    paths:
     - '.github/workflows/stubgen.yaml'
     - 'faster_eth_abi/**.py'
     - 'pyproject.toml'
     - 'setup.py'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  stubgen:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install mypy
        run: pip install mypy

      - name: Generate stubs with stubgen
        run: |
          rm -rf stubs
          mkdir stubs
          stubgen faster_eth_abi -o types-eth-abi

      - name: Duplicate stubs for eth_abi
        run: |
          cp -r types-eth-abi/faster_eth_abi types-eth-abi/eth_abi

      - name: Copy LICENSE
        run: cp LICENSE types-eth-abi/LICENSE

      - name: Update LICENSE copyright
        run: |
          sed -i 's/Copyright (c) 2016-2020, 2022-2025 The Ethereum Foundation/Copyright (c) 2025 BobTheBuidler/' types-eth-abi/LICENSE

      - name: Create py.typed
        run: touch types-eth-abi/py.typed

      - name: Create README.md for stubs
        run: |
          echo "# types-faster-eth-utils" > types-eth-abi/README.md
          echo "" >> types-eth-abi/README.md
          echo "Type stubs for the faster_eth_abi library, generated automatically via stubgen." >> types-eth-abi/README.md
          echo "" >> types-eth-abi/README.md
          echo "## eth_abi compatibility" >> types-eth-abi/README.md
          echo "" >> types-eth-abi/README.md
          echo "For compatibility, the stubs for \`faster_eth_abi\` are also duplicated as \`eth_abi\` in this package. This allows these type stubs to be used with both the \`eth-abi\` and \`faster-eth-abi\` libraries." >> types-eth-abi/README.md

      - name: Generate egg-info
        run: python setup.py egg_info

      - name: Extract metadata from egg-info
        id: get_metadata
        run: |
          VERSION=$(grep '^Version:' *.egg-info/PKG-INFO | head -n1 | awk '{print $2}')
          PYTHON_REQUIRES=$(grep '^Requires-Python:' *.egg-info/PKG-INFO | head -n1 | awk '{print $2}')
          URL=$(grep '^Home-page:' *.egg-info/PKG-INFO | head -n1 | cut -d' ' -f2-)
          LICENSE=$(grep '^License:' *.egg-info/PKG-INFO | head -n1 | cut -d' ' -f2-)
          KEYWORDS=$(grep '^Keywords:' *.egg-info/PKG-INFO | head -n1 | cut -d' ' -f2-)
          if [ -z "$PYTHON_REQUIRES" ]; then
            PYTHON_REQUIRES=">=3.7"
          fi
          if [ -z "$URL" ]; then
            URL="https://github.com/BobTheBuidler/faster-eth-abi"
          fi
          if [ -z "$LICENSE" ]; then
            LICENSE="MIT"
          fi
          if [ -z "$KEYWORDS" ]; then
            KEYWORDS="ethereum"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "PYTHON_REQUIRES=$PYTHON_REQUIRES" >> $GITHUB_ENV
          echo "URL=$URL" >> $GITHUB_ENV
          echo "LICENSE=$LICENSE" >> $GITHUB_ENV
          echo "KEYWORDS=$KEYWORDS" >> $GITHUB_ENV

      - name: Create setup.py for types-faster-eth-utils from template
        run: |
          cp types-eth-abi/setup.template.py types-eth-abi/setup.py
          sed -i "s/{{VERSION}}/$VERSION/g" types-eth-abi/setup.py
          sed -i "s/{{PYTHON_REQUIRES}}/$PYTHON_REQUIRES/g" types-eth-abi/setup.py
          sed -i "s|{{URL}}|$URL|g" types-eth-abi/setup.py
          sed -i "s|{{LICENSE}}|$LICENSE|g" types-eth-abi/setup.py
          sed -i "s|{{KEYWORDS}}|$KEYWORDS|g" types-eth-abi/setup.py

      - name: Create MANIFEST.in
        run: |
          echo "include LICENSE" > types-eth-abi/MANIFEST.in
          echo "include README.md" >> types-eth-abi/MANIFEST.in
          echo "include py.typed" >> types-eth-abi/MANIFEST.in
          echo "recursive-include faster_eth_abi *.pyi" >> types-eth-abi/MANIFEST.in
          echo "recursive-include eth_abi *.pyi" >> types-eth-abi/MANIFEST.in

      - name: Check for stubs changes
        id: stubs_diff
        run: |
          git fetch origin
          git add types-eth-abi/
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.stubs_diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          branch: auto/update-stubs
          base: ${{ github.base_ref }}
          title: "chore(mypy): update type stubs [automated]"
          body: "This PR updates `types-eth-abi` based on the latest implementation. Generated by GitHub Actions."
          commit-message: "chore(mypy): update type stubs [automated]"
