name: Generate Type Stubs

on:
  push:
    branches: [main, master]
    paths:
     - '.github/workflows/stubgen.yaml'
     - 'faster_eth_abi/**.py'
     - 'pyproject.toml'
     - 'setup.py'
  pull_request:
    branches: [main, master]
    paths:
     - '.github/workflows/stubgen.yaml'
     - 'faster_eth_abi/**.py'
     - 'pyproject.toml'
     - 'setup.py'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  stubgen:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install mypy
        run: pip install mypy

      - name: Delete existing stubs
        run: rm -rf types-eth-abi/eth_abi types-eth-abi/faster_eth_abi
      
      - name: Generate stubs with stubgen
        run: stubgen faster_eth_abi -o types-eth-abi --include-private

      - name: Create py.typed
        run: touch types-eth-abi/faster_eth_abi/py.typed

      - name: Duplicate stubs for eth_abi
        run: |
          cp -r types-eth-abi/faster_eth_abi types-eth-abi/eth_abi
          cp types-eth-abi/faster_eth_abi/typing.py types-eth-abi/eth_abi/typing.pyi
          rm types-eth-abi/eth_abi/_codec.pyi
          rm types-eth-abi/eth_abi/_decoding.pyi
          rm types-eth-abi/eth_abi/_encoding.pyi
          rm types-eth-abi/eth_abi/_grammar.pyi

      - name: Generate egg-info
        run: python setup.py egg_info

      - name: Extract metadata from egg-info
        id: get_metadata
        run: |
          VERSION=$(grep '^Version:' *.egg-info/PKG-INFO | head -n1 | awk '{print $2}')
          PYTHON_REQUIRES=$(grep '^Requires-Python:' *.egg-info/PKG-INFO | head -n1 | awk '{print $2}')
          URL=$(grep '^Home-page:' *.egg-info/PKG-INFO | head -n1 | cut -d' ' -f2-)
          LICENSE=$(grep '^License:' *.egg-info/PKG-INFO | head -n1 | cut -d' ' -f2-)
          KEYWORDS=$(grep '^Keywords:' *.egg-info/PKG-INFO | head -n1 | cut -d' ' -f2-)
          if [ -z "$PYTHON_REQUIRES" ]; then
            PYTHON_REQUIRES=">=3.7"
          fi
          if [ -z "$URL" ]; then
            URL="https://github.com/BobTheBuidler/faster-eth-abi"
          fi
          if [ -z "$LICENSE" ]; then
            LICENSE="MIT"
          fi
          if [ -z "$KEYWORDS" ]; then
            KEYWORDS="ethereum"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "PYTHON_REQUIRES=$PYTHON_REQUIRES" >> $GITHUB_ENV
          echo "URL=$URL" >> $GITHUB_ENV
          echo "LICENSE=$LICENSE" >> $GITHUB_ENV
          echo "KEYWORDS=$KEYWORDS" >> $GITHUB_ENV

      - name: Create setup.py for types-eth-abi from template
        run: |
          cp types-eth-abi/setup.template.py types-eth-abi/setup.py
          sed -i "s/{{VERSION}}/$VERSION/g" types-eth-abi/setup.py
          sed -i "s/{{PYTHON_REQUIRES}}/$PYTHON_REQUIRES/g" types-eth-abi/setup.py
          sed -i "s|{{URL}}|$URL|g" types-eth-abi/setup.py
          sed -i "s|{{LICENSE}}|$LICENSE|g" types-eth-abi/setup.py
          sed -i "s|{{KEYWORDS}}|$KEYWORDS|g" types-eth-abi/setup.py

      - name: Check for stubs changes
        id: stubs_diff
        run: |
          git fetch origin
          git add types-eth-abi/
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.stubs_diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          branch: auto/update-stubs
          base: ${{ github.base_ref }}
          title: "chore(mypy): update type stubs [automated]"
          body: "This PR updates `types-eth-abi` based on the latest implementation. Generated by GitHub Actions."
          commit-message: "chore(mypy): update type stubs [automated]"
