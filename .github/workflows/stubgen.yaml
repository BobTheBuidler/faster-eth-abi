name: Generate Stubs Package

on:
  push:
    branches: [main, master]
    paths:
     - '.github/workflows/stubgen.yaml'
     - 'faster_eth_abi/**.py'
     - 'pyproject.toml'
     - 'setup.py'
  pull_request:
    branches: [main, master]
    paths:
     - '.github/workflows/stubgen.yaml'
     - 'faster_eth_abi/**.py'
     - 'pyproject.toml'
     - 'setup.py'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  stubgen:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements-mypy.txt') }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install mypy, black, & requirements
        run: pip install black -r requirements-mypy.txt

      - name: Delete existing stubs
        run: rm -rf eth-abi-stubs/eth_abi eth-abi-stubs/faster_eth_abi

      - name: Generate stubs with stubgen
        run: stubgen faster_eth_abi -o eth-abi-stubs --include-docstrings -v

      - name: Migrate encode/decode stubs from codec.pyi to abi.pyi
        run: |
          awk '
          /^@overload/ {in_overload=1; block=""; block=block $0 "\n"; next}
          /^def (encode|decode)\(/ {
            in_func=1; block=block $0 "\n"; next
          }
          in_func && /^[ ]{4}/ {block=block $0 "\n"; next}
          (in_func || in_overload) && !/^[ ]{4}/ {
            in_func=0; in_overload=0;
            gsub(/^ {4}/, "", block)
            gsub(/\(self,? ?/, "(", block)
            print block "\n"
            block=""
          }
          ' eth-abi-stubs/faster_eth_abi/codec.pyi >> eth-abi-stubs/faster_eth_abi/abi.pyi

      - name: Create py.typed
        run: touch eth-abi-stubs/faster_eth_abi/py.typed

      - name: Copy typing.py to typing.pyi
        run: cp faster_eth_abi/typing.py eth-abi-stubs/faster_eth_abi/typing.pyi

      - name: Run Black formatter
        run: black eth-abi-stubs

      - name: Duplicate stubs for eth_abi
        run: cp -r eth-abi-stubs/faster_eth_abi eth-abi-stubs/eth_abi

      - name: Remove modules specific to faster-eth-abi
        run: |
          rm eth-abi-stubs/eth_abi/_codec.pyi
          rm eth-abi-stubs/eth_abi/_decoding.pyi
          rm eth-abi-stubs/eth_abi/_encoding.pyi
          rm eth-abi-stubs/eth_abi/_grammar.pyi
          rm eth-abi-stubs/eth_abi/io.pyi

      - name: Remove modules where definitions differ from eth-abi
        run: |
          rm eth-abi-stubs/eth_abi/exceptions.pyi

      - name: Prepend stub-only docstring to eth_abi/typing.pyi
        run: |
          docstring='"""This file exists in faster_eth_abi but not in eth_abi. It is present here only for type checking and is crucial for the stubs package to function. Do not expect eth_abi.typing to exist at runtime."""'
          tmpfile=$(mktemp)
          echo "$docstring" > $tmpfile
          cat eth-abi-stubs/eth_abi/typing.pyi >> $tmpfile
          mv $tmpfile eth-abi-stubs/eth_abi/typing.pyi

      - name: Prepend stub-only docstring to eth_abi/from_type_str.pyi
        run: |
          docstring='"""This file exists in faster_eth_abi but not in eth_abi. It is present here only for type checking and is crucial for the stubs package to function. Do not expect eth_abi.typing to exist at runtime."""'
          tmpfile=$(mktemp)
          echo "$docstring" > $tmpfile
          cat eth-abi-stubs/eth_abi/typing.pyi >> $tmpfile
          mv $tmpfile eth-abi-stubs/eth_abi/typing.pyi

      - name: Extract eth-abi version from requirements.txt and set stubs version
        id: get_eth_abi_version
        run: |
          ETH_ABI_VERSION=$(grep '^eth-abi==' requirements.txt | head -n1 | cut -d'=' -f3)
          DATE=$(date +%Y%m%d)
          STUBS_VERSION="$ETH_ABI_VERSION.$DATE"
          echo "STUBS_VERSION=$STUBS_VERSION" >> $GITHUB_ENV

      - name: Generate egg-info
        run: python setup.py egg_info

      - name: Extract metadata from egg-info
        id: get_metadata
        run: |
          PYTHON_REQUIRES=$(grep '^Requires-Python:' *.egg-info/PKG-INFO | head -n1 | awk '{print $2}')
          URL=$(grep '^Home-page:' *.egg-info/PKG-INFO | head -n1 | cut -d' ' -f2-)
          LICENSE=$(grep '^License:' *.egg-info/PKG-INFO | head -n1 | cut -d' ' -f2-)
          KEYWORDS=$(grep '^Keywords:' *.egg-info/PKG-INFO | head -n1 | cut -d' ' -f2-)
          if [ -z "$PYTHON_REQUIRES" ]; then
            PYTHON_REQUIRES=">=3.7"
          fi
          if [ -z "$URL" ]; then
            URL="https://github.com/BobTheBuidler/faster-eth-abi"
          fi
          if [ -z "$LICENSE" ]; then
            LICENSE="MIT"
          fi
          if [ -z "$KEYWORDS" ]; then
            KEYWORDS="ethereum"
          fi
          echo "PYTHON_REQUIRES=$PYTHON_REQUIRES" >> $GITHUB_ENV
          echo "URL=$URL" >> $GITHUB_ENV
          echo "LICENSE=$LICENSE" >> $GITHUB_ENV
          echo "KEYWORDS=$KEYWORDS" >> $GITHUB_ENV

      - name: Create setup.py for eth-abi-stubs from template
        run: |
          cp eth-abi-stubs/setup.template.py eth-abi-stubs/setup.py
          sed -i "s/{{VERSION}}/$STUBS_VERSION/g" eth-abi-stubs/setup.py
          sed -i "s/{{PYTHON_REQUIRES}}/$PYTHON_REQUIRES/g" eth-abi-stubs/setup.py
          sed -i "s|{{URL}}|$URL|g" eth-abi-stubs/setup.py
          sed -i "s|{{LICENSE}}|$LICENSE|g" eth-abi-stubs/setup.py
          sed -i "s|{{KEYWORDS}}|$KEYWORDS|g" eth-abi-stubs/setup.py

      - name: Check for stubs changes
        id: stubs_diff
        run: |
          git add eth-abi-stubs/
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.stubs_diff.outputs.changed == 'true'
        id: create-pull-request
        uses: peter-evans/create-pull-request@v7
        with:
          branch: auto/stubgen/${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}
          base: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}
          title: "chore(mypy): update type stubs [automated]"
          body: |
            This PR updates `eth-abi-stubs` based on the latest implementation. Generated by GitHub Actions.
            ${{ github.event_name == 'pull_request' && format('Triggered by PR: #{0} ({1})', github.event.pull_request.number, github.event.pull_request.html_url) || '' }}

      - name: Comment on trigger PR with automation PR link
        if: github.event_name == 'pull_request' && steps.stubs_diff.outputs.changed == 'true'
        env:
          BRANCH_NAME: auto/stubgen/${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}
        uses: actions/github-script@v8
        with:
          script: |
            const triggerPR = context.payload.pull_request;
            const branchName = process.env.BRANCH_NAME;
            const stubgenPR = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: branchName,
              state: 'open'
            });
            if (triggerPR && stubgenPR.data.length > 0) {
              const stubgenPRUrl = stubgenPR.data[0].html_url;
              const commentBody = `Hi! I'm a helpful automation ðŸ¤–. I generated a PR to update stubs for your changes: ${stubgenPRUrl}\n\nPlease merge it to ensure your PR meets repo standards.`;
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: triggerPR.number,
                per_page: 100
              });
              const alreadyExists = comments.data.some(c => c.body === commentBody);
              if (!alreadyExists) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: triggerPR.number,
                  body: commentBody
                });
              }
            }
